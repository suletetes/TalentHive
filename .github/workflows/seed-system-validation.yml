name: Consolidated Seed System Validation

# Run this workflow on schedule to validate seed system performance
# and data quality over time
on:
  schedule:
    # Run every day at 2 AM UTC to validate seed system
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'testing'
        type: choice
        options:
        - testing
        - development
        - demo
      run_performance_tests:
        description: 'Run performance validation tests'
        required: false
        default: true
        type: boolean
      run_quality_tests:
        description: 'Run data quality validation tests'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  seed-validation:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install dependencies
      run: |
        cd server
        npm ci

    - name: Install MongoDB Shell
      run: |
        wget https://downloads.mongodb.com/compass/mongosh-2.1.1-linux-x64.tgz
        tar -xzf mongosh-2.1.1-linux-x64.tgz
        sudo mv mongosh-2.1.1-linux-x64/bin/* /usr/local/bin/
        sudo chmod +x /usr/local/bin/mongosh

    - name: Setup MongoDB
      run: |
        sleep 15
        mongosh "mongodb://admin:password@localhost:27017/admin" --eval "db.adminCommand('ping')"

    - name: Validate seed system configuration
      run: |
        cd server
        npm run seed:config:validate -- --environment ${{ github.event.inputs.environment || 'testing' }}
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_validation?authSource=admin
        JWT_SECRET: validation_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: validation_refresh_secret_very_long_for_security_purposes

    - name: Run comprehensive seed test
      run: |
        cd server
        npm run seed -- --environment ${{ github.event.inputs.environment || 'testing' }} --dry-run
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_validation?authSource=admin
        JWT_SECRET: validation_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: validation_refresh_secret_very_long_for_security_purposes

    - name: Run performance validation
      if: ${{ github.event.inputs.run_performance_tests != 'false' }}
      run: |
        cd server
        timeout 150s npm run seed:performance:validate --export performance-validation-report.json
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_validation?authSource=admin
        JWT_SECRET: validation_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: validation_refresh_secret_very_long_for_security_purposes

    - name: Run data quality validation
      if: ${{ github.event.inputs.run_quality_tests != 'false' }}
      run: |
        cd server
        npm run seed:quality --export quality-validation-report.json
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_validation?authSource=admin
        JWT_SECRET: validation_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: validation_refresh_secret_very_long_for_security_purposes

    - name: Run integration tests
      run: |
        cd server
        npm run seed:test:integration
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_validation?authSource=admin
        JWT_SECRET: validation_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: validation_refresh_secret_very_long_for_security_purposes

    - name: Generate validation summary
      run: |
        cd server
        mkdir -p validation-reports
        echo "# Seed System Validation Report - $(date)" > validation-reports/summary.md
        echo "" >> validation-reports/summary.md
        echo "## Environment: ${{ github.event.inputs.environment || 'testing' }}" >> validation-reports/summary.md
        echo "## Timestamp: $(date -u)" >> validation-reports/summary.md
        echo "" >> validation-reports/summary.md
        
        # Add configuration summary
        echo "## Configuration Summary" >> validation-reports/summary.md
        npm run seed:config:show -- --environment ${{ github.event.inputs.environment || 'testing' }} >> validation-reports/summary.md
        
        # Add status check
        echo "" >> validation-reports/summary.md
        echo "## Database Status" >> validation-reports/summary.md
        npm run seed:status >> validation-reports/summary.md || echo "Status check failed" >> validation-reports/summary.md
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_validation?authSource=admin
        JWT_SECRET: validation_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: validation_refresh_secret_very_long_for_security_purposes

    - name: Upload validation reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: seed-validation-reports-${{ github.event.inputs.environment || 'testing' }}-${{ github.run_number }}
        path: |
          server/validation-reports/
          server/*-validation-report.json
        retention-days: 90

    - name: Notify on failure
      if: failure()
      run: |
        echo "::error::Seed system validation failed for environment: ${{ github.event.inputs.environment || 'testing' }}"
        echo "::error::Check the uploaded artifacts for detailed reports"

    - name: Notify on success
      if: success()
      run: |
        echo "::notice::Seed system validation passed for environment: ${{ github.event.inputs.environment || 'testing' }}"