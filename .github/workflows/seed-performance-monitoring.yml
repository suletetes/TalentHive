name: Seed System Performance Monitoring

# Monitor seed system performance to ensure it meets the 2-minute requirement
# and track performance trends over time
on:
  schedule:
    # Run performance monitoring twice daily
    - cron: '0 6,18 * * *'
  workflow_dispatch:
    inputs:
      dataset_size:
        description: 'Dataset size to test'
        required: true
        default: 'medium'
        type: choice
        options:
        - small
        - medium
        - large
      export_detailed_report:
        description: 'Export detailed performance report'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  performance-monitoring:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install dependencies
      run: |
        cd server
        npm ci

    - name: Install MongoDB Shell
      run: |
        wget https://downloads.mongodb.com/compass/mongosh-2.1.1-linux-x64.tgz
        tar -xzf mongosh-2.1.1-linux-x64.tgz
        sudo mv mongosh-2.1.1-linux-x64/bin/* /usr/local/bin/
        sudo chmod +x /usr/local/bin/mongosh

    - name: Setup MongoDB
      run: |
        sleep 15
        mongosh "mongodb://admin:password@localhost:27017/admin" --eval "db.adminCommand('ping')"

    - name: Run performance benchmark - Small Dataset
      run: |
        cd server
        echo "=== Small Dataset Performance Test ===" | tee -a performance-results.txt
        timeout 60s npm run seed:performance:benchmark -- --sizes small --export small-dataset-report.json | tee -a performance-results.txt
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_perf_small?authSource=admin
        JWT_SECRET: perf_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: perf_refresh_secret_very_long_for_security_purposes

    - name: Run performance benchmark - Medium Dataset
      run: |
        cd server
        echo "=== Medium Dataset Performance Test ===" | tee -a performance-results.txt
        timeout 90s npm run seed:performance:benchmark -- --sizes medium --export medium-dataset-report.json | tee -a performance-results.txt
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_perf_medium?authSource=admin
        JWT_SECRET: perf_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: perf_refresh_secret_very_long_for_security_purposes

    - name: Run performance benchmark - Large Dataset (2-minute requirement test)
      run: |
        cd server
        echo "=== Large Dataset Performance Test (2-minute requirement) ===" | tee -a performance-results.txt
        timeout 150s npm run seed:performance:benchmark -- --sizes large --export large-dataset-report.json | tee -a performance-results.txt
        
        # Check if it completed within 2 minutes
        if [ $? -eq 0 ]; then
          echo "âœ… 2-minute requirement MET" | tee -a performance-results.txt
        else
          echo "âŒ 2-minute requirement NOT MET" | tee -a performance-results.txt
          exit 1
        fi
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_perf_large?authSource=admin
        JWT_SECRET: perf_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: perf_refresh_secret_very_long_for_security_purposes

    - name: Run comprehensive performance validation
      run: |
        cd server
        echo "=== Comprehensive Performance Validation ===" | tee -a performance-results.txt
        npm run seed:performance:validate --export comprehensive-performance-report.json | tee -a performance-results.txt
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_perf_comprehensive?authSource=admin
        JWT_SECRET: perf_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: perf_refresh_secret_very_long_for_security_purposes

    - name: Generate performance trend report
      run: |
        cd server
        mkdir -p performance-reports
        
        # Create performance summary
        echo "# Seed System Performance Report - $(date)" > performance-reports/performance-summary.md
        echo "" >> performance-reports/performance-summary.md
        echo "## Test Environment" >> performance-reports/performance-summary.md
        echo "- Runner: ubuntu-latest" >> performance-reports/performance-summary.md
        echo "- Node.js: ${{ env.NODE_VERSION }}" >> performance-reports/performance-summary.md
        echo "- MongoDB: 7.0" >> performance-reports/performance-summary.md
        echo "- Timestamp: $(date -u)" >> performance-reports/performance-summary.md
        echo "" >> performance-reports/performance-summary.md
        
        # Add performance results
        echo "## Performance Results" >> performance-reports/performance-summary.md
        echo '```' >> performance-reports/performance-summary.md
        cat performance-results.txt >> performance-reports/performance-summary.md
        echo '```' >> performance-reports/performance-summary.md
        
        # Copy all report files
        cp *-dataset-report.json performance-reports/ 2>/dev/null || true
        cp comprehensive-performance-report.json performance-reports/ 2>/dev/null || true

    - name: Check 2-minute requirement compliance
      run: |
        cd server
        echo "Checking 2-minute requirement compliance..."
        
        # This will exit with code 1 if requirement is not met
        npm run seed:performance:validate --threshold 120000
      env:
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_perf_requirement?authSource=admin
        JWT_SECRET: perf_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: perf_refresh_secret_very_long_for_security_purposes

    - name: Upload performance reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-monitoring-reports-${{ github.run_number }}
        path: |
          server/performance-reports/
          server/performance-results.txt
        retention-days: 180

    - name: Create performance issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ðŸš¨ Seed System Performance Issue - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Performance Monitoring Alert
          
          The seed system performance monitoring has detected issues that require attention.
          
          **Details:**
          - Workflow Run: ${{ github.run_number }}
          - Timestamp: ${new Date().toISOString()}
          - Branch: ${{ github.ref_name }}
          
          **Possible Issues:**
          - 2-minute seeding requirement not met
          - Performance degradation detected
          - System resource constraints
          
          **Next Steps:**
          1. Review the performance reports in the workflow artifacts
          2. Check for recent changes that might impact performance
          3. Consider optimizing database operations or batch sizes
          4. Verify system resources and MongoDB configuration
          
          **Artifacts:**
          Check the workflow artifacts for detailed performance reports and logs.
          `;
          
          // Check if issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['performance', 'seed-system'],
            state: 'open'
          });
          
          if (issues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['performance', 'seed-system', 'monitoring']
            });
          }

    - name: Performance success notification
      if: success()
      run: |
        echo "::notice::âœ… All performance tests passed!"
        echo "::notice::2-minute requirement compliance verified"
        echo "::notice::Performance reports uploaded to artifacts"