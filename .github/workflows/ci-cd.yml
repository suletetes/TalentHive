name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  # Backend Tests
  backend-test:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install backend dependencies
      run: |
        cd server
        npm ci

    - name: Install MongoDB Shell (mongosh)
      run: |
        # Download and install mongosh directly from MongoDB
        wget https://downloads.mongodb.com/compass/mongosh-2.1.1-linux-x64.tgz
        tar -xzf mongosh-2.1.1-linux-x64.tgz
        sudo mv mongosh-2.1.1-linux-x64/bin/* /usr/local/bin/
        sudo chmod +x /usr/local/bin/mongosh
        # Verify installation
        mongosh --version

    - name: Setup MongoDB test database
      run: |
        # Wait for MongoDB to be ready
        sleep 15
        
        # Verify MongoDB is running
        mongosh "mongodb://admin:password@localhost:27017/admin" --eval "db.adminCommand('ping')"
        
        # Create test database and user
        mongosh "mongodb://admin:password@localhost:27017/admin" --eval "
          db.createUser({
            user: 'testuser',
            pwd: 'testpass',
            roles: [
              { role: 'readWrite', db: 'talenthive_test' },
              { role: 'dbAdmin', db: 'talenthive_test' }
            ]
          });
        "
        
        # Create the test database
        mongosh "mongodb://admin:password@localhost:27017/talenthive_test" --eval "
          db.createCollection('test');
        "

    - name: Seed test database
      run: |
        cd server
        npm run seed
      env:
        NODE_ENV: test
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_test?authSource=admin
        REDIS_URL: redis://localhost:6379
        JWT_SECRET: test_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: test_refresh_secret_very_long_for_security_purposes
        JWT_EXPIRES_IN: 24h
        JWT_REFRESH_EXPIRES_IN: 7d
        SENDGRID_API_KEY: SG.test-api-key-for-testing
        FROM_EMAIL: test@talenthive.com
        FROM_NAME: TalentHive Test
        STRIPE_SECRET_KEY: sk_test_mock_key
        STRIPE_PUBLISHABLE_KEY: pk_test_mock_key
        STRIPE_WEBHOOK_SECRET: whsec_test_mock_secret
        CLOUDINARY_CLOUD_NAME: test-cloud
        CLOUDINARY_API_KEY: test-api-key
        CLOUDINARY_API_SECRET: test-api-secret

    - name: Run backend linting
      run: |
        cd server
        npm run lint || true

    - name: Run backend tests
      run: |
        cd server
        npm test
      env:
        NODE_ENV: test
        MONGODB_URI: mongodb://admin:password@localhost:27017/talenthive_test?authSource=admin
        MONGODB_TEST_URI: mongodb://admin:password@localhost:27017/talenthive_test?authSource=admin
        REDIS_URL: redis://localhost:6379
        JWT_SECRET: test_jwt_secret_very_long_for_security_purposes
        JWT_REFRESH_SECRET: test_refresh_secret_very_long_for_security_purposes
        JWT_EXPIRES_IN: 24h
        JWT_REFRESH_EXPIRES_IN: 7d
        SENDGRID_API_KEY: SG.test-api-key-for-testing
        FROM_EMAIL: test@talenthive.com
        FROM_NAME: TalentHive Test
        STRIPE_SECRET_KEY: sk_test_mock_key
        STRIPE_PUBLISHABLE_KEY: pk_test_mock_key
        STRIPE_WEBHOOK_SECRET: whsec_test_mock_secret
        CLOUDINARY_CLOUD_NAME: test-cloud
        CLOUDINARY_API_KEY: test-api-key
        CLOUDINARY_API_SECRET: test-api-secret

  # Frontend Tests
  frontend-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd client
        npm ci

    - name: Run frontend linting
      run: |
        cd client
        npm run lint || true

    - name: Run frontend tests
      run: |
        cd client
        npm test -- --run  || true

    - name: Build frontend
      run: |
        cd client
        npm run build
      env:
        VITE_API_URL: http://localhost:5000/api

  # Security Audit
  security-audit:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Run backend security audit
      run: |
        cd server
        npm audit --audit-level moderate
      continue-on-error: true

    - name: Run frontend security audit
      run: |
        cd client
        npm audit --audit-level moderate
      continue-on-error: true

  # =============================================================================
  # PRODUCTION DEPLOYMENT (COMMENTED OUT)
  # =============================================================================
  # Uncomment the sections below when ready for production deployment.
  # 
  # Required GitHub Secrets for production:
  # - VITE_API_URL: Production API URL (e.g., https://api.talenthive.com)
  # - VITE_STRIPE_PUBLISHABLE_KEY: Stripe publishable key for production
  # - PRODUCTION_HOST: Production server hostname/IP
  # - PRODUCTION_USER: SSH username for production server
  # - PRODUCTION_SSH_KEY: SSH private key for production server
  # =============================================================================

  # # Build and Push Docker Images
  # build-and-push:
  #   runs-on: ubuntu-latest
  #   needs: [backend-test, frontend-test, security-audit]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   
  #   permissions:
  #     contents: read
  #     packages: write
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #
  #   - name: Set up Docker Buildx
  #     uses: docker/setup-buildx-action@v3
  #
  #   - name: Log in to GitHub Container Registry
  #     uses: docker/login-action@v3
  #     with:
  #       registry: ghcr.io
  #       username: ${{ github.actor }}
  #       password: ${{ secrets.GITHUB_TOKEN }}
  #
  #   - name: Extract metadata for backend
  #     id: meta-backend
  #     uses: docker/metadata-action@v5
  #     with:
  #       images: ghcr.io/${{ github.repository }}/backend
  #       tags: |
  #         type=ref,event=branch
  #         type=sha,prefix={{branch}}-
  #         type=raw,value=latest,enable={{is_default_branch}}
  #
  #   - name: Build and push backend image
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: ./server
  #       file: ./server/Dockerfile
  #       push: true
  #       tags: ${{ steps.meta-backend.outputs.tags }}
  #       labels: ${{ steps.meta-backend.outputs.labels }}
  #       cache-from: type=gha
  #       cache-to: type=gha,mode=max
  #
  #   - name: Extract metadata for frontend
  #     id: meta-frontend
  #     uses: docker/metadata-action@v5
  #     with:
  #       images: ghcr.io/${{ github.repository }}/frontend
  #       tags: |
  #         type=ref,event=branch
  #         type=sha,prefix={{branch}}-
  #         type=raw,value=latest,enable={{is_default_branch}}
  #
  #   - name: Build and push frontend image
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: ./client
  #       file: ./client/Dockerfile.prod
  #       push: true
  #       tags: ${{ steps.meta-frontend.outputs.tags }}
  #       labels: ${{ steps.meta-frontend.outputs.labels }}
  #       build-args: |
  #         VITE_API_URL=${{ secrets.VITE_API_URL }}
  #         VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
  #       cache-from: type=gha
  #       cache-to: type=gha,mode=max

  # # Deploy to Production
  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: [build-and-push]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   
  #   environment:
  #     name: production
  #     url: https://talenthive.com
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #
  #   - name: Deploy to production server
  #     uses: appleboy/ssh-action@v1.0.0
  #     with:
  #       host: ${{ secrets.PRODUCTION_HOST }}
  #       username: ${{ secrets.PRODUCTION_USER }}
  #       key: ${{ secrets.PRODUCTION_SSH_KEY }}
  #       script: |
  #         cd /opt/talenthive
  #         
  #         # Pull latest code
  #         git pull origin main
  #         
  #         # Pull latest Docker images
  #         docker-compose -f docker-compose.prod.yml pull
  #         
  #         # Deploy with zero downtime
  #         docker-compose -f docker-compose.prod.yml up -d --remove-orphans
  #         
  #         # Clean up old images
  #         docker image prune -f
  #         
  #         # Wait for services to be healthy
  #         sleep 30
  #         
  #         # Health check
  #         curl -f http://localhost:5000/api/health || exit 1
  #         curl -f http://localhost/health || exit 1
  #
  #   - name: Notify deployment success
  #     if: success()
  #     run: echo "Deployment successful!"
  #
  #   - name: Notify deployment failure
  #     if: failure()
  #     run: echo "Deployment failed!"
